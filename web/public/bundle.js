function removeTones(e){const n={"̀":"","́":"","̉":"","̃":"","̣":""},s=e.normalize("NFD");let t="";for(const e of s)t+=n[e]??e;return t.normalize("NFC")}function makePlain(e){let n=e.replace(/\u0110/g,"D").replace(/\u0111/g,"d");return n=n.normalize("NFKD"),n=n.replace(/[\u0300-\u036f]/g,""),n}function escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}async function loadGzipJson(e){const n=await fetch(e),s=await n.blob(),t=new DecompressionStream("gzip"),a=s.stream().pipeThrough(t),o=await new Response(a).text();return JSON.parse(o)}function linkifyFromList(e,n=[]){if(!n||0===n.length)return escapeHtml(e);let s=escapeHtml(e);const t=[...n].sort((e,n)=>n.length-e.length),a=[];for(const e of t){const n=RegExp.escape(e),t=new RegExp(`(?<![\\p{L}\\p{M}])(${n})(?![\\p{L}\\p{M}])`,"gui");let o,i="",r=0;const l=new RegExp(t.source,t.flags);for(;null!==(o=l.exec(s));){const n=o.index,t=o.index+o[0].length;if(!a.some(e=>n>=e.start&&n<e.end||t>e.start&&t<=e.end||n<=e.start&&t>=e.end)){i+=s.substring(r,n);const l=`<a href="#" class="vn-link" data-word="${escapeHtml(e.toLowerCase())}">${o[0]}</a>`;i+=l;const c=i.length-l.length,d=i.length;a.push({start:c,end:d}),r=t}}i+=s.substring(r),s=i}return s}function boldify(e,n=[]){if(0===n.length)return escapeHtml(e);const s=e.split(/(\s+)/);let t="",a=0;return s.forEach(e=>{const s=a,o=a+e.length,i=n.some(([e,n])=>s<n&&o>e);t+=i?`<strong>${escapeHtml(e)}</strong>`:escapeHtml(e),a=o}),t}function segmentVietnamese(e,n=[]){const{vnHeadwordSet:s}=getData(),t=Array.isArray(n)?n.slice().sort((e,n)=>e[0]-n[0]).filter(([n,s])=>n>=0&&s>n&&s<=e.length):[],a=e.match(/[\p{L}\p{N}-]+|\s+|[^\p{L}\p{N}\s-]+/gu)||[];let o=0;const i=a.map(e=>{const n=o,s=n+e.length;o=s;const a=/\p{L}/u.test(e),i=t.some(([e,t])=>n<t&&s>e);return{text:e,isWord:a,isSpace:/^\s+$/.test(e),isPunct:!a&&!/^\s+$/.test(e),isBold:i}}),r=i.filter(e=>e.isWord).map(e=>e.text),l=r.map(e=>e.toLowerCase());let c=0;const d=[];for(let e=0;e<i.length;e++){const n=i[e];if(n.isSpace){d.push({display:n.text,key:null,isPunct:!1,isSpace:!0,inDictionary:!1,isBold:n.isBold});continue}if(n.isPunct){d.push({display:n.text,key:null,isPunct:!0,isSpace:!1,inDictionary:!1,isBold:n.isBold});continue}let t=null,a=null,o=0;for(let e=r.length;e>c;e--){const n=l.slice(c,e).join(" ");if(s.has(n)){a=n,t=r.slice(c,e).join(" "),o=e-c;break}}if(t){d.push({display:t,key:a,isPunct:!1,isSpace:!1,inDictionary:!0,isBold:i[e].isBold});let n=0;for(let s=e;s<i.length&&n<o;s++)i[s].isWord&&n++,e=s;c+=o}else{const e=r[c];d.push({display:e,key:l[c],isPunct:!1,isSpace:!1,inDictionary:!1,isBold:n.isBold}),c++}}return d}function linkifySegments(e){let n="",s=!1;for(let t=0;t<e.length;t++){const a=e[t],o=e[t-1],i=a.isPunct,r=/[([{“"']$/.test(a.display),l=/^[)\]}”"',:;\.\?!]/.test(a.display),c=o?.isPunct,d=o&&/[([{“"']$/.test(o.display),u=o&&/^[)\]}”"',:;\.\?!]$/.test(o.display);if(a.isBold&&!s?(n+="<strong>",s=!0):!a.isBold&&s&&(n+="</strong>",s=!1),t>0){let e=!0;l||r||d?e=!1:c&&!u?e=!0:c||i?u&&!i&&(e=!0):e=!0,e&&(n+=" ")}i?n+=a.display:a.inDictionary?n+=`<a href="#" class="vn-link" data-word="${escapeHtml(a.key)}">${escapeHtml(a.display)}</a>`:n+=escapeHtml(a.display)}return s&&(n+="</strong>"),n}RegExp.escape||(RegExp.escape=function(e){return String(e).replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")});var vnEn=[],enVn=[],vnIndex=null,enIndex=null,glossDocIndex=null,vnHeadwordSet=null;async function initializeData(){[vnEn,enVn]=await Promise.all([loadGzipJson("../data/vnen.json.gz"),loadGzipJson("../data/envn.json.gz")]),vnIndex=new Map,vnEn.forEach((e,n)=>{e._idx=n;const s=[e.searchable.lowercase,e.searchable.toneless,e.searchable.plain];for(const e of s)for(const s of e)vnIndex.has(s)||vnIndex.set(s,new Set),vnIndex.get(s).add(n)}),console.log(`Vietnamese index: ${vnIndex.size} unique terms`),enIndex=new Map,enVn.forEach((e,n)=>{e._idx=n;const s=e.lowercase;enIndex.has(s)||enIndex.set(s,[]),enIndex.get(s).push(n)}),console.log(`English index: ${enIndex.size} unique terms`),glossDocIndex=new FlexSearch.Document({id:"_idx",document:{id:"_idx",store:!0,index:["gloss"]},tokenize:"forward",optimize:!0,resolution:9,depth:2,bidirectional:!1}),vnEn.forEach((e,n)=>{e._idx=n;const s=[];e.lexemes&&Array.isArray(e.lexemes)&&e.lexemes.forEach(e=>{e.senses&&Array.isArray(e.senses)&&e.senses.forEach(e=>{e.gloss&&"string"==typeof e.gloss&&s.push(e.gloss.toLowerCase())})}),s.length>0&&glossDocIndex.add({_idx:n,gloss:s.join(" ")})}),vnHeadwordSet=new Set,vnEn.forEach(e=>{e.searchable.lowercase.forEach(e=>vnHeadwordSet.add(e))})}function getData2(){return{vnEn:vnEn,enVn:enVn,vnIndex:vnIndex,enIndex:enIndex,glossDocIndex:glossDocIndex,vnHeadwordSet:vnHeadwordSet}}function isCanonicalMatch(e,n,s){return s[e].word.toLowerCase()===n}function searchVietnameseHeadwords(e){const{vnEn:n,vnIndex:s}=getData2();if(!s)return[];const t=e.trim().toLowerCase(),a=removeTones(t),o=makePlain(t),i=new Set,r=(e,n)=>{if(e.has(n))for(const s of e.get(n))i.add(s)},l=new Map;r(s,t),s.has(t)&&s.get(t).forEach(e=>{l.set(e,{exact:!0,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,t,n)})});const c=i.size>0;if(c||(r(s,a),s.has(a)&&s.get(a).forEach(e=>{l.has(e)||l.set(e,{exact:!1,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,t,n)})})),/^[a-zA-Z\s]+$/.test(e)&&(r(s,o),s.has(o)&&s.get(o).forEach(e=>{l.has(e)||l.set(e,{exact:!1,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,t,n)})})),i.size<10){const r=[t,a];/^[a-zA-Z\s]+$/.test(e)&&r.push(o);for(const[r,d]of s){let s;if(c?s=[t]:(s=[t,a],/^[a-zA-Z\s]+$/.test(e)&&s.push(o)),s.some(e=>new RegExp(`(^|\\s)${RegExp.escape(e)}`).test(r)))for(const s of d)if(i.add(s),!l.has(s)){const i=n[s].word.toLowerCase(),r=i.startsWith(t)||i.startsWith(a)||/^[a-zA-Z\s]+$/.test(e)&&i.startsWith(o);l.set(s,{exact:!1,startsWith:r,length:i.length})}}}return Array.from(i).map(e=>({idx:e,...l.get(e)})).sort((e,s)=>{if(e.exact&&!s.exact)return-1;if(!e.exact&&s.exact)return 1;if(e.exact&&s.exact){if(e.canonical&&!s.canonical)return-1;if(!e.canonical&&s.canonical)return 1}if(e.startsWith&&!s.startsWith)return-1;if(!e.startsWith&&s.startsWith)return 1;if(e.length!==s.length)return e.length-s.length;const t=n[e.idx].rank||1/0,a=n[s.idx].rank||1/0;if(t!==a)return t-a;const o=n[e.idx].word,i=n[s.idx].word,r=n[e.idx].searchable.lowercase[0]||o.toLowerCase(),l=n[s.idx].searchable.lowercase[0]||i.toLowerCase();return r<l?-1:r>l?1:o===r&&i!==l?-1:i===l&&o!==r?1:0}).slice(0,20).map(e=>n[e.idx])}function searchEnglishHeadwords(e){const{enVn:n,enIndex:s}=getData2();if(!s)return[];const t=e.toLowerCase().trim();if(!t)return[];const a=new Set;s.has(t)&&s.get(t).forEach(e=>a.add(e));for(const[e,n]of s)e.startsWith(t)&&n.forEach(e=>a.add(e));return Array.from(a).map(e=>n[e]).sort((e,n)=>{const s=e.lowercase,a=n.lowercase;return s===t&&a!==t?-1:a===t&&s!==t?1:s.length-a.length}).slice(0,20)}function searchEnglishGlosses(e){const{vnEn:n,glossDocIndex:s}=getData2();if(!s)return[];const t=e.toLowerCase().trim();if(!t)return[];const a=s.search(t,{limit:100,field:"gloss",enrich:!0,suggest:!0}),o=new Map;a.forEach(e=>{e.result&&Array.isArray(e.result)&&e.result.forEach(e=>{const s=n[e.id];if(!o.has(e.id)){const n=findBestMatchingGloss(s,t);n&&o.set(e.id,{word:s,score:n.score,matchedGloss:n.gloss})}})});const i=Array.from(o.values());return i.sort((e,n)=>n.score-e.score),i.slice(0,10).map(e=>e.word)}function scoreGlossMatch(e,n){const s=e.toLowerCase(),t=n.toLowerCase(),a=s.split(/;/).map(e=>e.trim());let o=0;for(const e of a){const n=e.split(/[,\s]+/).filter(e=>e.length>0),s=n.length,a=n.indexOf(t),i=n.findIndex(e=>e.startsWith(t)),r=e.includes(t);let l=0;if(-1!==a){l+=1e3/(a+1)}else if(-1!==i){l+=500/(i+1)}else r&&(l+=50);l*=1+t.split(/\s+/).length/s,s>8&&(l*=.5),o=Math.max(o,l)}return o}function findBestMatchingGloss(e,n){let s=null,t=0;if(!e.lexemes)return null;if(e.lexemes.forEach(e=>{e.senses&&e.senses.forEach(e=>{e.glosses&&e.glosses.forEach(e=>{const a=scoreGlossMatch(e,n);a>t&&(t=a,s=e)})})}),!s)return null;let a=t;return e.rank&&(e.rank<=1e3?a*=1.1:e.rank<=3e3&&(a*=1.05)),{gloss:s,score:a}}function search(e){if(!e.trim())return{type:"empty"};const n={type:"combined",vnHeadwords:[],enHeadwords:[],enGlosses:[]};n.vnHeadwords=searchVietnameseHeadwords(e),n.enHeadwords=searchEnglishHeadwords(e);const s=n.vnHeadwords.length>0||n.enHeadwords.length>0,t=n.enHeadwords.some(n=>n.lowercase===e);return/^[a-zA-Z ]+$/.test(e)&&!t&&(n.enGlosses=searchEnglishGlosses(e),n.enGlosses.length>0&&(n.type="includes-reverse")),s||n.enGlosses.length?n:{type:"none"}}Handlebars.registerHelper("join",function(e,n){return e?e.join(n):""}),Handlebars.registerHelper("eq",function(e,n){return e===n}),Handlebars.registerHelper("linkifyFromList",function(e,n){return new Handlebars.SafeString(linkifyFromList(e,n))}),Handlebars.registerHelper("linkify",function(e,n){const s=segmentVietnamese(e,Array.isArray(n)?n:[]);return new Handlebars.SafeString(linkifySegments(s))}),Handlebars.registerHelper("boldify",function(e,n){return new Handlebars.SafeString(boldify(e,n))}),Handlebars.registerHelper("rankBadge",function(e){return e?e<=1e3?'<span class="rank-badge core">Top 1000</span>':e<=3e3?'<span class="rank-badge common">Top 3000</span>':e<=5e3?'<span class="rank-badge general">Top 5000</span>':"":""}),Handlebars.registerHelper("audioButton",function(e,n){return`\n        <button class="audio-button" data-filename="${`${e.toLowerCase().replace(/\s+/g,"-")}-${n}.mp3`}" \n        data-dialect="${n.toUpperCase()}">\n            <span class="audio-icon"><i class="twa twa-speaker-low-volume"></i></span> \n            ${n.toUpperCase()}\n        </button>\n    `}),Handlebars.registerHelper("gt",(e,n)=>e>n),Handlebars.registerHelper("lte",(e,n)=>e<=n),Handlebars.registerHelper("and",(e,n)=>e&&n);var searchTimeout,vnHeadwordTemplate=Handlebars.compile('\n<div class="result">\n    <div class="headword-row">\n        {{word}}\n        {{#if alt_spelling}}\n            <span class="alt-spelling">(<em>also:</em> <strong>{{alt_spelling}}</strong>)</span>\n        {{/if}}\n        {{#if has_audio}}{{{audioButton word "hn"}}}{{/if}}\n        {{#if has_audio}}{{{audioButton word "sg"}}}{{/if}}\n        {{{rankBadge rank}}}\n    </div>\n    \n    {{#if phonetic_hn}}\n        <div class="phonetic">\n            <strong>HN</strong> <em>{{phonetic_hn}}</em> <strong>SG</strong> <em>{{phonetic_sg}}</em>\n        </div>\n    {{/if}}\n    <div class="ipa">\n        <strong>HN</strong> /{{ipa_hn}}/ <strong>SG</strong> /{{ipa_sg}}/\n    </div>\n    \n    {{#each lexemes}}\n        <div class="lexeme">\n            <div class="header">\n                <h3 class="pos">{{pos}}</h3>\n                {{#if classifier}}<span class="classifier">(<em>classifier:</em> <strong>{{classifier}}</strong>)</span>{{/if}}\n            </div>\n            <ul class="senses">\n                {{#each senses}}\n                    <li class="sense">\n                        {{#if tags}}\n                            <ul class="tags">\n                                {{#each tags}}<li class="tag">{{this}}</li>{{/each}}\n                            </ul>\n                        {{/if}}\n                        {{#if qualifiers}}\n                            <span class="qualifiers">{{join qualifiers ", "}}</span>\n                        {{/if}}\n                        {{{linkifyFromList gloss links}}}\n                        {{#if examples}}\n                            <ul class="examples">\n                                {{#each examples}}\n                                    <li class="example">\n                                        {{#if bold_vi_offsets}}\n                                            {{{linkify vi bold_vi_offsets}}}\n                                        {{else}}\n                                            {{{vi}}}\n                                        {{/if}}\n                                        —\n                                        {{#if bold_en_offsets}}\n                                            {{{boldify en bold_en_offsets}}}\n                                        {{else}}\n                                            {{{en}}}\n                                        {{/if}}\n                                        {{#if literal}}<span class="literal"> (lit: {{literal}})</span>{{/if}}\n                                        {{#if note}}<span class="note"> ({{note}})</span>{{/if}}\n                                    </li>\n                                {{/each}}\n                            </ul>\n                        {{/if}}\n                    </li>\n                {{/each}}\n            </ul>\n        </div>\n    {{/each}}\n</div>\n'),enHeadwordTemplate=Handlebars.compile('\n<div class="result">\n    <div class="headword-row">\n        {{en}}\n    </div>\n    \n    {{#each lexemes}}\n        <div class="lexeme">\n            <div class="header">\n                <h3 class="pos">{{pos}}</h3>\n            </div>\n            <ul class="senses">\n                {{#each senses}}\n                    <li class="sense">\n                        {{#if sense}}<em>{{sense}}:</em>{{/if}}\n                        {{#each translations}}\n                            {{{linkify vn}}}{{#if note}}<span class="note"> ({{note}})</span>{{/if}}{{#unless @last}}, {{/unless}}\n                        {{/each}}\n                    </li>\n                {{/each}}\n            </ul>\n        </div>\n    {{/each}}\n</div>\n'),ipaMode=!1;function setIpaMode(e){ipaMode=e,document.querySelectorAll(".phonetic").forEach(n=>{n.style.display=e?"none":""}),document.querySelectorAll(".ipa").forEach(n=>{n.style.display=e?"":"none"})}function getIpaMode(){return ipaMode}function renderVietnameseHeadwords(e){return 0===e.length?'<div class="no-results">No Vietnamese results</div>':e.map(e=>vnHeadwordTemplate(e)).join("")}function renderEnglishHeadwords(e){return 0===e.length?'<div class="no-results">No English results</div>':e.map(e=>enHeadwordTemplate(e)).join("")}function displayResults(e){const n=document.getElementById("results");if("empty"===e.type)return void(n.innerHTML="");if("none"===e.type)return void(n.innerHTML='<div class="no-results">No results found</div>');const s=[];e.vnHeadwords&&e.vnHeadwords.length>0&&s.push(renderSection("Vietnamese",renderVietnameseHeadwords(e.vnHeadwords))),e.enHeadwords&&e.enHeadwords.length>0&&s.push(renderSection("English",renderEnglishHeadwords(e.enHeadwords))),"includes-reverse"===e.type&&s.push('<div class="no-results">No exact English matches found. Here are some Vietnamese words whose definitions contain your search term.</div>'),e.enGlosses&&e.enGlosses.length>0&&s.push(renderSection("Reverse lookup",renderVietnameseHeadwords(e.enGlosses))),n.innerHTML=s.join("")}function setDarkMode(e){document.documentElement.setAttribute("data-theme",e?"dark":"light")}function initUI(){const e="true"===localStorage.getItem("saola_ipaMode");setIpaMode(e);const n=document.getElementById("ipa-toggle");n&&(e?n.classList.add("active"):n.classList.remove("active"));const s=localStorage.getItem("saola_darkMode"),t=window.matchMedia("(prefers-color-scheme: dark)").matches,a=null!==s?"true"===s:t;setDarkMode(a);const o=document.getElementById("dark-mode-toggle");o&&(a?o.classList.add("active"):o.classList.remove("active")),document.getElementById("search").addEventListener("input",e=>{clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{performSearch()},150)}),document.getElementById("ipa-toggle").addEventListener("click",function(){const e=!this.classList.contains("active");setIpaMode(e),this.classList.toggle("active"),localStorage.setItem("saola_ipaMode",e.toString()),this.blur()}),document.getElementById("dark-mode-toggle").addEventListener("click",function(){const e=!this.classList.contains("active");setDarkMode(e),this.classList.toggle("active"),localStorage.setItem("saola_darkMode",e.toString()),this.blur()}),document.addEventListener("click",e=>{const n=e.target.closest(".vn-link");if(n){e.preventDefault();const s=n.dataset.word;return document.getElementById("search").value=s,void performSearch()}const s=e.target.closest(".audio-button");if(s)return console.log("Audio button clicked"),e.preventDefault(),void handleAudioClick(s);const t=e.target.closest(".section-title.collapsible");if(t){const e=t.closest(".search-section"),n=(e.querySelector(".section-content"),t.querySelector(".toggle-icon"));return e.classList.toggle("open"),void(n.textContent=e.classList.contains("open")?"▼":"▶")}}),setupModalHandlers()}function performSearch(){displayResults(search(document.getElementById("search").value)),setIpaMode(getIpaMode())}function setupModalHandlers(){document.getElementById("help-button")?.addEventListener("click",()=>{openModal("help")}),document.getElementById("about-button")?.addEventListener("click",()=>{openModal("about")}),document.getElementById("modal-close")?.addEventListener("click",closeModal),document.getElementById("modal")?.addEventListener("click",e=>{"modal"===e.target.id&&closeModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeModal()})}async function openModal(e){const n=document.getElementById("modal"),s=document.getElementById("modal-body");s.innerHTML="<p>Loading...</p>",n.classList.add("active"),document.body.style.overflow="hidden";try{const n=await fetch(`../md/${e}.md`),t=await n.text();s.innerHTML=marked.parse(t).replace(/@\/(.+?)\/@/g,'<span class="ipa">/$1/</span>')}catch(e){s.innerHTML="<p>Error loading content.</p>"}}function closeModal(){document.getElementById("modal").classList.remove("active"),document.body.style.overflow=""}function handleAudioClick(e){const n=e.dataset.filename,s=new Audio(`https://pub-9ec168b9602247ec9a07b5964680de73.r2.dev/${n}?v=v1`);e.classList.add("playing"),e.disabled=!0,s.onended=()=>{e.classList.remove("playing"),e.disabled=!1},s.onerror=()=>{console.error("Audio error:",n),e.innerHTML="❌"},s.play().catch(n=>{console.error("Play failed:",n),e.innerHTML="❌"})}async function init(){const e=document.querySelector(".search-container"),n=document.getElementById("loading");n.textContent="Loading dictionary...";try{await initializeData(),n.style.display="none",e.classList.add("ready"),document.getElementById("search").focus(),initUI()}catch(e){console.error("Error during initialization:",e),n.textContent="Error loading dictionary: "+e.message}}init();