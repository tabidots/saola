export function removeTones(e){const n={"̀":"","́":"","̉":"","̃":"","̣":""},t=e.normalize("NFD");let s="";for(const e of t)s+=n[e]??e;return s.normalize("NFC")}export function makePlain(e){let n=e.replace(/\u0110/g,"D").replace(/\u0111/g,"d");return n=n.normalize("NFKD"),n=n.replace(/[\u0300-\u036f]/g,""),n}export function escapeHtml(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}export async function loadGzipJson(e){const n=await fetch(e),t=await n.blob(),s=new DecompressionStream("gzip"),o=t.stream().pipeThrough(s),a=await new Response(o).text();return JSON.parse(a)}RegExp.escape||(RegExp.escape=function(e){return String(e).replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")});export function linkifyFromList(e,n=[]){if(!n||0===n.length)return escapeHtml(e);let t=escapeHtml(e);const s=[...n].sort((e,n)=>n.length-e.length),o=[];for(const e of s){const n=RegExp.escape(e),s=new RegExp(`(?<![\\p{L}\\p{M}])(${n})(?![\\p{L}\\p{M}])`,"gui");let a,r="",i=0;const l=new RegExp(s.source,s.flags);for(;null!==(a=l.exec(t));){const n=a.index,s=a.index+a[0].length;if(!o.some(e=>n>=e.start&&n<e.end||s>e.start&&s<=e.end||n<=e.start&&s>=e.end)){r+=t.substring(i,n);const l=`<a href="#" class="vn-link" data-word="${escapeHtml(e.toLowerCase())}">${a[0]}</a>`;r+=l;const c=r.length-l.length,d=r.length;o.push({start:c,end:d}),i=s}}r+=t.substring(i),t=r}return t}export function boldify(e,n=[]){if(0===n.length)return escapeHtml(e);const t=e.split(/(\s+)/);let s="",o=0;return t.forEach(e=>{const t=o,a=o+e.length,r=n.some(([e,n])=>t<n&&a>e);s+=r?`<strong>${escapeHtml(e)}</strong>`:escapeHtml(e),o=a}),s}export function segmentVietnamese(e,n=[]){const{vnHeadwordSet:t}=getData(),s=Array.isArray(n)?n.slice().sort((e,n)=>e[0]-n[0]).filter(([n,t])=>n>=0&&t>n&&t<=e.length):[],o=e.match(/[\p{L}\p{N}-]+|\s+|[^\p{L}\p{N}\s-]+/gu)||[];let a=0;const r=o.map(e=>{const n=a,t=n+e.length;a=t;const o=/\p{L}/u.test(e),r=s.some(([e,s])=>n<s&&t>e);return{text:e,isWord:o,isSpace:/^\s+$/.test(e),isPunct:!o&&!/^\s+$/.test(e),isBold:r}}),i=r.filter(e=>e.isWord).map(e=>e.text),l=i.map(e=>e.toLowerCase());let c=0;const d=[];for(let e=0;e<r.length;e++){const n=r[e];if(n.isSpace){d.push({display:n.text,key:null,isPunct:!1,isSpace:!0,inDictionary:!1,isBold:n.isBold});continue}if(n.isPunct){d.push({display:n.text,key:null,isPunct:!0,isSpace:!1,inDictionary:!1,isBold:n.isBold});continue}let s=null,o=null,a=0;for(let e=i.length;e>c;e--){const n=l.slice(c,e).join(" ");if(t.has(n)){o=n,s=i.slice(c,e).join(" "),a=e-c;break}}if(s){d.push({display:s,key:o,isPunct:!1,isSpace:!1,inDictionary:!0,isBold:r[e].isBold});let n=0;for(let t=e;t<r.length&&n<a;t++)r[t].isWord&&n++,e=t;c+=a}else{const e=i[c];d.push({display:e,key:l[c],isPunct:!1,isSpace:!1,inDictionary:!1,isBold:n.isBold}),c++}}return d}export function linkifySegments(e){let n="",t=!1;for(let s=0;s<e.length;s++){const o=e[s],a=e[s-1],r=o.isPunct,i=/[([{“"']$/.test(o.display),l=/^[)\]}”"',:;\.\?!]/.test(o.display),c=a?.isPunct,d=a&&/[([{“"']$/.test(a.display),p=a&&/^[)\]}”"',:;\.\?!]$/.test(a.display);if(o.isBold&&!t?(n+="<strong>",t=!0):!o.isBold&&t&&(n+="</strong>",t=!1),s>0){let e=!0;l||i||d?e=!1:c&&!p?e=!0:c||r?p&&!r&&(e=!0):e=!0,e&&(n+=" ")}r?n+=o.display:o.inDictionary?n+=`<a href="#" class="vn-link" data-word="${escapeHtml(o.key)}">${escapeHtml(o.display)}</a>`:n+=escapeHtml(o.display)}return t&&(n+="</strong>"),n}import{loadGzipJson}from"./utils.js";export let vnEn=[];export let enVn=[];export let vnIndex=null;export let enIndex=null;export let glossDocIndex=null;export let vnHeadwordSet=null;export async function initializeData(){[vnEn,enVn]=await Promise.all([loadGzipJson("../data/vnen.json.gz"),loadGzipJson("../data/envn.json.gz")]),vnIndex=new Map,vnEn.forEach((e,n)=>{e._idx=n;const t=[e.searchable.lowercase,e.searchable.toneless,e.searchable.plain];for(const e of t)for(const t of e)vnIndex.has(t)||vnIndex.set(t,new Set),vnIndex.get(t).add(n)}),console.log(`Vietnamese index: ${vnIndex.size} unique terms`),enIndex=new Map,enVn.forEach((e,n)=>{e._idx=n;const t=e.lowercase;enIndex.has(t)||enIndex.set(t,[]),enIndex.get(t).push(n)}),console.log(`English index: ${enIndex.size} unique terms`),glossDocIndex=new FlexSearch.Document({id:"_idx",document:{id:"_idx",store:!0,index:["gloss"]},tokenize:"forward",optimize:!0,resolution:9,depth:2,bidirectional:!1}),vnEn.forEach((e,n)=>{e._idx=n;const t=[];e.lexemes&&Array.isArray(e.lexemes)&&e.lexemes.forEach(e=>{e.senses&&Array.isArray(e.senses)&&e.senses.forEach(e=>{e.gloss&&"string"==typeof e.gloss&&t.push(e.gloss.toLowerCase())})}),t.length>0&&glossDocIndex.add({_idx:n,gloss:t.join(" ")})}),vnHeadwordSet=new Set,vnEn.forEach(e=>{e.searchable.lowercase.forEach(e=>vnHeadwordSet.add(e))})}export function getData(){return{vnEn:vnEn,enVn:enVn,vnIndex:vnIndex,enIndex:enIndex,glossDocIndex:glossDocIndex,vnHeadwordSet:vnHeadwordSet}}import{removeTones,makePlain}from"./utils.js";import{getData}from"./data-loader.js";function isCanonicalMatch(e,n,t){return t[e].word.toLowerCase()===n}export function searchVietnameseHeadwords(e){const{vnEn:n,vnIndex:t}=getData();if(!t)return[];const s=e.trim().toLowerCase(),o=removeTones(s),a=makePlain(s),r=new Set,i=(e,n)=>{if(e.has(n))for(const t of e.get(n))r.add(t)},l=new Map;i(t,s),t.has(s)&&t.get(s).forEach(e=>{l.set(e,{exact:!0,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,s,n)})});const c=r.size>0;if(c||(i(t,o),t.has(o)&&t.get(o).forEach(e=>{l.has(e)||l.set(e,{exact:!1,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,s,n)})})),/^[a-zA-Z\s]+$/.test(e)&&(i(t,a),t.has(a)&&t.get(a).forEach(e=>{l.has(e)||l.set(e,{exact:!1,startsWith:!0,length:n[e].word.length,canonical:isCanonicalMatch(e,s,n)})})),r.size<10){const i=[s,o];/^[a-zA-Z\s]+$/.test(e)&&i.push(a);for(const[i,d]of t){let t;if(c?t=[s]:(t=[s,o],/^[a-zA-Z\s]+$/.test(e)&&t.push(a)),t.some(e=>new RegExp(`(^|\\s)${RegExp.escape(e)}`).test(i)))for(const t of d)if(r.add(t),!l.has(t)){const r=n[t].word.toLowerCase(),i=r.startsWith(s)||r.startsWith(o)||/^[a-zA-Z\s]+$/.test(e)&&r.startsWith(a);l.set(t,{exact:!1,startsWith:i,length:r.length})}}}return Array.from(r).map(e=>({idx:e,...l.get(e)})).sort((e,t)=>{if(e.exact&&!t.exact)return-1;if(!e.exact&&t.exact)return 1;if(e.exact&&t.exact){if(e.canonical&&!t.canonical)return-1;if(!e.canonical&&t.canonical)return 1}if(e.startsWith&&!t.startsWith)return-1;if(!e.startsWith&&t.startsWith)return 1;if(e.length!==t.length)return e.length-t.length;const s=n[e.idx].rank||1/0,o=n[t.idx].rank||1/0;if(s!==o)return s-o;const a=n[e.idx].word,r=n[t.idx].word,i=n[e.idx].searchable.lowercase[0]||a.toLowerCase(),l=n[t.idx].searchable.lowercase[0]||r.toLowerCase();return i<l?-1:i>l?1:a===i&&r!==l?-1:r===l&&a!==i?1:0}).slice(0,20).map(e=>n[e.idx])}export function searchEnglishHeadwords(e){const{enVn:n,enIndex:t}=getData();if(!t)return[];const s=e.toLowerCase().trim();if(!s)return[];const o=new Set;t.has(s)&&t.get(s).forEach(e=>o.add(e));for(const[e,n]of t)e.startsWith(s)&&n.forEach(e=>o.add(e));return Array.from(o).map(e=>n[e]).sort((e,n)=>{const t=e.lowercase,o=n.lowercase;return t===s&&o!==s?-1:o===s&&t!==s?1:t.length-o.length}).slice(0,20)}export function searchEnglishGlosses(e){const{vnEn:n,glossDocIndex:t}=getData();if(!t)return[];const s=e.toLowerCase().trim();if(!s)return[];const o=t.search(s,{limit:100,field:"gloss",enrich:!0,suggest:!0}),a=new Map;o.forEach(e=>{e.result&&Array.isArray(e.result)&&e.result.forEach(e=>{const t=n[e.id];if(!a.has(e.id)){const n=findBestMatchingGloss(t,s);n&&a.set(e.id,{word:t,score:n.score,matchedGloss:n.gloss})}})});const r=Array.from(a.values());return r.sort((e,n)=>n.score-e.score),r.slice(0,10).map(e=>e.word)}function scoreGlossMatch(e,n){const t=e.toLowerCase(),s=n.toLowerCase(),o=t.split(/;/).map(e=>e.trim());let a=0;for(const e of o){const n=e.split(/[,\s]+/).filter(e=>e.length>0),t=n.length,o=n.indexOf(s),r=n.findIndex(e=>e.startsWith(s)),i=e.includes(s);let l=0;if(-1!==o){l+=1e3/(o+1)}else if(-1!==r){l+=500/(r+1)}else i&&(l+=50);l*=1+s.split(/\s+/).length/t,t>8&&(l*=.5),a=Math.max(a,l)}return a}function findBestMatchingGloss(e,n){let t=null,s=0;if(!e.lexemes)return null;if(e.lexemes.forEach(e=>{e.senses&&e.senses.forEach(e=>{e.glosses&&e.glosses.forEach(e=>{const o=scoreGlossMatch(e,n);o>s&&(s=o,t=e)})})}),!t)return null;let o=s;return e.rank&&(e.rank<=1e3?o*=1.1:e.rank<=3e3&&(o*=1.05)),{gloss:t,score:o}}export function search(e){if(!e.trim())return{type:"empty"};const n={type:"combined",vnHeadwords:[],enHeadwords:[],enGlosses:[]};n.vnHeadwords=searchVietnameseHeadwords(e),n.enHeadwords=searchEnglishHeadwords(e);const t=n.vnHeadwords.length>0||n.enHeadwords.length>0,s=n.enHeadwords.some(n=>n.lowercase===e);return/^[a-zA-Z ]+$/.test(e)&&!s&&(n.enGlosses=searchEnglishGlosses(e),n.enGlosses.length>0&&(n.type="includes-reverse")),t||n.enGlosses.length?n:{type:"none"}}import{segmentVietnamese,linkifyFromList,linkifySegments,boldify}from"./utils.js";Handlebars.registerHelper("join",function(e,n){return e?e.join(n):""}),Handlebars.registerHelper("eq",function(e,n){return e===n}),Handlebars.registerHelper("linkifyFromList",function(e,n){return new Handlebars.SafeString(linkifyFromList(e,n))}),Handlebars.registerHelper("linkify",function(e,n){const t=Array.isArray(n)?n:[],s=segmentVietnamese(e,t);return new Handlebars.SafeString(linkifySegments(s))}),Handlebars.registerHelper("boldify",function(e,n){return new Handlebars.SafeString(boldify(e,n))}),Handlebars.registerHelper("rankBadge",function(e){return e?e<=1e3?'<span class="rank-badge core">Top 1000</span>':e<=3e3?'<span class="rank-badge common">Top 3000</span>':e<=5e3?'<span class="rank-badge general">Top 5000</span>':"":""}),Handlebars.registerHelper("audioButton",function(e,n){return`\n        <button class="audio-button" data-filename="${`${e.toLowerCase().replace(/\s+/g,"-")}-${n}.mp3`}" \n        data-dialect="${n.toUpperCase()}">\n            <span class="audio-icon"><i class="twa twa-speaker-low-volume"></i></span> \n            ${n.toUpperCase()}\n        </button>\n    `}),Handlebars.registerHelper("gt",(e,n)=>e>n),Handlebars.registerHelper("lte",(e,n)=>e<=n),Handlebars.registerHelper("and",(e,n)=>e&&n);export const vnHeadwordTemplate=Handlebars.compile('\n<div class="result">\n    <div class="headword-row">\n        {{word}}\n        {{#if alt_spelling}}\n            <span class="alt-spelling">(<em>also:</em> <strong>{{alt_spelling}}</strong>)</span>\n        {{/if}}\n        {{#if has_audio}}{{{audioButton word "hn"}}}{{/if}}\n        {{#if has_audio}}{{{audioButton word "sg"}}}{{/if}}\n        {{{rankBadge rank}}}\n    </div>\n    \n    {{#if phonetic_hn}}\n        <div class="phonetic">\n            <strong>HN</strong> <em>{{phonetic_hn}}</em> <strong>SG</strong> <em>{{phonetic_sg}}</em>\n        </div>\n    {{/if}}\n    <div class="ipa">\n        <strong>HN</strong> /{{ipa_hn}}/ <strong>SG</strong> /{{ipa_sg}}/\n    </div>\n    \n    {{#each lexemes}}\n        <div class="lexeme">\n            <div class="header">\n                <h3 class="pos">{{pos}}</h3>\n                {{#if classifier}}<span class="classifier">(<em>classifier:</em> <strong>{{classifier}}</strong>)</span>{{/if}}\n            </div>\n            <ul class="senses">\n                {{#each senses}}\n                    <li class="sense">\n                        {{#if tags}}\n                            <ul class="tags">\n                                {{#each tags}}<li class="tag">{{this}}</li>{{/each}}\n                            </ul>\n                        {{/if}}\n                        {{#if qualifiers}}\n                            <span class="qualifiers">{{join qualifiers ", "}}</span>\n                        {{/if}}\n                        {{{linkifyFromList gloss links}}}\n                        {{#if examples}}\n                            <ul class="examples">\n                                {{#each examples}}\n                                    <li class="example">\n                                        {{#if bold_vi_offsets}}\n                                            {{{linkify vi bold_vi_offsets}}}\n                                        {{else}}\n                                            {{{vi}}}\n                                        {{/if}}\n                                        —\n                                        {{#if bold_en_offsets}}\n                                            {{{boldify en bold_en_offsets}}}\n                                        {{else}}\n                                            {{{en}}}\n                                        {{/if}}\n                                        {{#if literal}}<span class="literal"> (lit: {{literal}})</span>{{/if}}\n                                        {{#if note}}<span class="note"> ({{note}})</span>{{/if}}\n                                    </li>\n                                {{/each}}\n                            </ul>\n                        {{/if}}\n                    </li>\n                {{/each}}\n            </ul>\n        </div>\n    {{/each}}\n</div>\n');export const enHeadwordTemplate=Handlebars.compile('\n<div class="result">\n    <div class="headword-row">\n        {{en}}\n    </div>\n    \n    {{#each lexemes}}\n        <div class="lexeme">\n            <div class="header">\n                <h3 class="pos">{{pos}}</h3>\n            </div>\n            <ul class="senses">\n                {{#each senses}}\n                    <li class="sense">\n                        {{#if sense}}<em>{{sense}}:</em>{{/if}}\n                        {{#each translations}}\n                            {{{linkify vn}}}{{#if note}}<span class="note"> ({{note}})</span>{{/if}}{{#unless @last}}, {{/unless}}\n                        {{/each}}\n                    </li>\n                {{/each}}\n            </ul>\n        </div>\n    {{/each}}\n</div>\n');const frequencyFilter='\n    Filter words:\n    <button type="button">All </button>\n    <button type="button">Common (top 3k)</button>\n    <button type="button">Core (top 1k)</button>\n';export function renderSection(e,n,t=!0){return`\n        <div class="search-section ${t?"open":""}" data-section="${e.toLowerCase().replace(/\s+/g,"-")}">\n            <h3 class="section-title collapsible">\n                <span class="toggle-icon">${t?"▼":"▶"}</span>\n                ${e}\n            </h3>\n            <div class="section-content">\n                ${n}\n            </div>\n        </div>\n    `}import{vnHeadwordTemplate,enHeadwordTemplate}from"./templates.js";let searchTimeout,ipaMode=!1;export function setIpaMode(e){ipaMode=e,document.querySelectorAll(".phonetic").forEach(n=>{n.style.display=e?"none":""}),document.querySelectorAll(".ipa").forEach(n=>{n.style.display=e?"":"none"})}export function getIpaMode(){return ipaMode}export function renderVietnameseHeadwords(e){return 0===e.length?'<div class="no-results">No Vietnamese results</div>':e.map(e=>vnHeadwordTemplate(e)).join("")}export function renderEnglishHeadwords(e){return 0===e.length?'<div class="no-results">No English results</div>':e.map(e=>enHeadwordTemplate(e)).join("")}export function displayResults(e){const n=document.getElementById("results");if("empty"===e.type)return void(n.innerHTML="");if("none"===e.type)return void(n.innerHTML='<div class="no-results">No results found</div>');const t=[];e.vnHeadwords&&e.vnHeadwords.length>0&&t.push(renderSection("Vietnamese",renderVietnameseHeadwords(e.vnHeadwords))),e.enHeadwords&&e.enHeadwords.length>0&&t.push(renderSection("English",renderEnglishHeadwords(e.enHeadwords))),"includes-reverse"===e.type&&t.push('<div class="no-results">No exact English matches found. Here are some Vietnamese words whose definitions contain your search term.</div>'),e.enGlosses&&e.enGlosses.length>0&&t.push(renderSection("Reverse lookup",renderVietnameseHeadwords(e.enGlosses))),n.innerHTML=t.join("")}import{search}from"./search.js";import{displayResults,setIpaMode,getIpaMode}from"./display.js";function setDarkMode(e){document.documentElement.setAttribute("data-theme",e?"dark":"light")}export function initUI(){const e="true"===localStorage.getItem("saola_ipaMode");setIpaMode(e);const n=document.getElementById("ipa-toggle");n&&(e?n.classList.add("active"):n.classList.remove("active"));const t=localStorage.getItem("saola_darkMode"),s=window.matchMedia("(prefers-color-scheme: dark)").matches,o=null!==t?"true"===t:s;setDarkMode(o);const a=document.getElementById("dark-mode-toggle");a&&(o?a.classList.add("active"):a.classList.remove("active")),document.getElementById("search").addEventListener("input",e=>{clearTimeout(searchTimeout),searchTimeout=setTimeout(()=>{performSearch()},150)}),document.getElementById("ipa-toggle").addEventListener("click",function(){const e=!this.classList.contains("active");setIpaMode(e),this.classList.toggle("active"),localStorage.setItem("saola_ipaMode",e.toString()),this.blur()}),document.getElementById("dark-mode-toggle").addEventListener("click",function(){const e=!this.classList.contains("active");setDarkMode(e),this.classList.toggle("active"),localStorage.setItem("saola_darkMode",e.toString()),this.blur()}),document.addEventListener("click",e=>{const n=e.target.closest(".vn-link");if(n){e.preventDefault();const t=n.dataset.word;return document.getElementById("search").value=t,void performSearch()}const t=e.target.closest(".audio-button");if(t)return console.log("Audio button clicked"),e.preventDefault(),void handleAudioClick(t);const s=e.target.closest(".section-title.collapsible");if(s){const e=s.closest(".search-section"),n=(e.querySelector(".section-content"),s.querySelector(".toggle-icon"));return e.classList.toggle("open"),void(n.textContent=e.classList.contains("open")?"▼":"▶")}}),setupModalHandlers()}function performSearch(){const e=document.getElementById("search").value,n=search(e);displayResults(n),setIpaMode(getIpaMode())}function setupModalHandlers(){document.getElementById("help-button")?.addEventListener("click",()=>{openModal("help")}),document.getElementById("about-button")?.addEventListener("click",()=>{openModal("about")}),document.getElementById("modal-close")?.addEventListener("click",closeModal),document.getElementById("modal")?.addEventListener("click",e=>{"modal"===e.target.id&&closeModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeModal()})}async function openModal(e){const n=document.getElementById("modal"),t=document.getElementById("modal-body");t.innerHTML="<p>Loading...</p>",n.classList.add("active"),document.body.style.overflow="hidden";try{const n=await fetch(`../md/${e}.md`),s=await n.text();t.innerHTML=marked.parse(s).replace(/@\/(.+?)\/@/g,'<span class="ipa">/$1/</span>')}catch(e){t.innerHTML="<p>Error loading content.</p>"}}function closeModal(){document.getElementById("modal").classList.remove("active"),document.body.style.overflow=""}export function handleAudioClick(e){const n=e.dataset.filename,t=new Audio(`https://pub-9ec168b9602247ec9a07b5964680de73.r2.dev/${n}?v=v1`);e.classList.add("playing"),e.disabled=!0,t.onended=()=>{e.classList.remove("playing"),e.disabled=!1},t.onerror=()=>{console.error("Audio error:",n),e.innerHTML="❌"},t.play().catch(n=>{console.error("Play failed:",n),e.innerHTML="❌"})}import{initializeData}from"./data-loader.js";import{initUI}from"./ui.js";async function init(){const e=document.querySelector(".search-container"),n=document.getElementById("loading");n.textContent="Loading dictionary...";try{await initializeData(),n.style.display="none",e.classList.add("ready"),document.getElementById("search").focus(),initUI()}catch(e){console.error("Error during initialization:",e),n.textContent="Error loading dictionary: "+e.message}}init();